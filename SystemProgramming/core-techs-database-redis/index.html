
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
  
  <title>Redis Notes | BN Stack</title>
  <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
  
  <meta name="author" content="juniway">
  

  
  <meta name="description" content="Redis Architecture DesignRedis is generally known as a single-process, single-thread model. This is not true. Redis also runs multiple backend threads to perform backend cleaning works, such as cleans">
<meta property="og:type" content="article">
<meta property="og:title" content="Redis Notes">
<meta property="og:url" content="https://juniway.net/SystemProgramming/core-techs-database-redis/index.html">
<meta property="og:site_name" content="BN Stack">
<meta property="og:description" content="Redis Architecture DesignRedis is generally known as a single-process, single-thread model. This is not true. Redis also runs multiple backend threads to perform backend cleaning works, such as cleans">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://juniway.net/image/database/redis_multi_threads.jpeg">
<meta property="og:image" content="https://juniway.net/image/database/redisObject.png">
<meta property="og:image" content="https://juniway.net/image/database/dict_struacture.png">
<meta property="og:image" content="https://juniway.net/image/database/redisServer.jpg">
<meta property="og:updated_time" content="2019-12-10T06:19:50.417Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Redis Notes">
<meta name="twitter:description" content="Redis Architecture DesignRedis is generally known as a single-process, single-thread model. This is not true. Redis also runs multiple backend threads to perform backend cleaning works, such as cleans">
<meta name="twitter:image" content="https://juniway.net/image/database/redis_multi_threads.jpeg">

  
  <link rel="alternative" href="/atom.xml" title="BN Stack" type="application/atom+xml">
  
  
  <link rel="icon" href="/img/author.jpeg">
  
  
  <link rel="apple-touch-icon" href="/img/author.jpeg">
  <link rel="apple-touch-icon-precomposed" href="/img/author.jpeg">
  
  <link rel="stylesheet" href="/css/style.css">

  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src= 'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f); })(window,document,'script','dataLayer','GTM-5KB3PM3');</script>>

  <script>
  (function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https'){
      bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else{
      bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
  })();
  </script>
</head>
</html>
  <body>
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-5KB3PM3"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <header>
      

<div>
	
		<div id="imglogo">
			<a href="/"><img src="/img/author0.png" alt="BN Stack" title="BN Stack"></a>
		</div>
	
	<div id="textlogo">
		<h1 class="site-name"><a href="/" title="BN Stack">BN Stack</a></h1>
		<h2 class="blog-motto"></h2>
	</div>
	<div class="navbar"><a class="navbutton navmobile" href="#" title="Menu"></a></div>

	<nav class="animated">
		<ul>
			<ul>
			 	
				<li><a href="/">Home</a></li>
				
				<li><a href="/archives">Archives</a></li>
				
				<li><a href="/about">About</a></li>
				
			<li>
				
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" name="q" autocomplete="off" maxlength="20" placeholder="Search">
						<input type="hidden" name="q" value="site:juniway.net">
					</form>
				
			</li>
		</ul>
	</ul></nav>
</div>

    </header>
    <div id="container">
      <div id="main" class="post" itemscope="" itemprop="blogPost">
  
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/SystemProgramming/core-techs-database-redis/" title="Redis Notes" itemprop="url">Redis Notes</a>
  </h1>

  <p class="article-time">
    <time datetime="2016-07-22T15:11:01.000Z"> 2016-07-22</time>
    <span class="post-count">字数 5k 阅读 12 评论 6</span>
  </p>
</header>
	<div class="article-content">
		
		<h1 id="Redis-Architecture-Design"><a href="#Redis-Architecture-Design" class="headerlink" title="Redis Architecture Design"></a>Redis Architecture Design</h1><p>Redis is generally known as a single-process, single-thread model. This is not true. Redis also runs multiple backend threads to perform backend cleaning works, such as cleansing the dirty data and closing file descriptors. In Redis, the main thread is responsible for the major tasks, including but not limited to: receiving the connections from clients, processing the connection read/write events, parsing requests, processing commands, processing timer events, and synchronizing data. Only one CPU core runs a single process and single thread. For small packets, a Redis server can process 80k to 100k QPS. A larger QPS is beyond the processing capacity of a Redis server. A common solution is to partition the data and adopt multiple servers in distributed architecture. However, this solution also has many drawbacks. For example, too many Redis servers to manage; some commands that are applicable to a single Redis server do not work on the data partitions; data partitions cannot solve the hot spot read/write problem; and data skew, redistribution, and scale-up/down become more complex. Due to restrictions of the single process and single thread, we hope that the multi-thread can be reconstructed to fully utilize the advantages of the SMP multi-core architecture, thus increasing the throughput of a single Redis server. To make Redis multi-threaded, the simplest way to think of is that every thread performs both I/O and command processing. However, as the data structure processed by Redis is complex, the multi-thread needs to use the locks to ensure the thread security. Improper handling of the lock granularity may deteriorate the performance.</p>
<p>We suggest that the number of I/O threads should be increased to enable an independent I/O thread to read/write data in the connections, parse commands, and reply data packets, and still let a single thread process the commands and execute the timer events. In this way, the throughput of a single Redis server can be increased.</p>
<p>单进程-单线程的优缺点</p>
<h2 id="Single-Process-and-Single-Thread-Model"><a href="#Single-Process-and-Single-Thread-Model" class="headerlink" title="Single Process and Single Thread Model"></a>Single Process and Single Thread Model</h2><h3 id="Advantages"><a href="#Advantages" class="headerlink" title="Advantages"></a>Advantages</h3><p>Due to restrictions of the single-process and single-thread model, time-consuming operations (such as dict rehash and expired key deletion) are broken into multiple steps and executed one by one in Redis implementation. This prevents execution of an operation for a long time and therefore avoids long time blocking of the system by an operation. The single-process and single-thread code is easy to compile, which reduces the context switching and lock seizure caused by multi-process and multi-thread.</p>
<h3 id="Disadvantages"><a href="#Disadvantages" class="headerlink" title="Disadvantages"></a>Disadvantages</h3><ul>
<li>Only one CPU core can be used, and the multi-core advantages cannot be utilized.</li>
<li>For heavy I/O applications, a large amount of CPU capacity is consumed by the network I/O operations. Applications that use Redis as cache are often heavy I/O applications. These applications basically have a high QPS, use relatively simple commands (such as get, set, and incr), but are RT sensitive. They often have a high bandwidth usage, which may even reach hundreds of megabits. Thanks to popularization of the 10-GB and 25-GB network adapters, the network bandwidth is no longer a bottleneck. Therefore, what we need to think about is how to utilize the advantages of multi-core and performance of the network adapter.</li>
</ul>
<p>单线程模型会严重影响整体的吞吐量，CPU计算过程中，整个IO调度都是被阻塞的。</p>
<p>为什么 Redis 使用单线程而不是多线程模型？</p>
<ul>
<li><strong>Ease of programming</strong> - Writing a multi-threaded program can be trickier. Sometimes multi-threading may not work, locks can block other threads.</li>
<li><strong>Concurrency</strong> can be achieved on single threaded system. Concurrency is not parallism.</li>
<li><strong>CPU is not bottleneck</strong> - Usually network is bottleneck. CPUs are very fast. If application is designed right, i.e. avoiding blocking IO, threading will be near the bottom of the list to worry about.</li>
<li><strong>Cost effective deployment</strong> - Such applications can work on any machine having at least a single CPU core.</li>
</ul>
<p>由于单线程无法发挥多核的优势，所以可以考虑改造为多线程，但需要考虑所增加的复杂度。</p>
<h1 id="Multi-Thread-Model-and-Implementation"><a href="#Multi-Thread-Model-and-Implementation" class="headerlink" title="Multi-Thread Model and Implementation"></a>Multi-Thread Model and Implementation</h1><h2 id="Thread-Model"><a href="#Thread-Model" class="headerlink" title="Thread Model"></a>Thread Model</h2><p>There are three thread types, namely:</p>
<ul>
<li>Main thread</li>
<li>I/O thread</li>
<li>Worker thread</li>
</ul>
<p>由一个主线程和多个 IO 线程组成。</p>
<ul>
<li>Main thread: Receives connections, creates clients, and forwards connections to the I/O thread.</li>
<li>I/O thread: Processes the connection read/write events, parses commands, forwards the complete parsed commands to the worker thread for processing, sends the response packets, and deletes connections.</li>
<li>Worker thread: Processes commands, generates the client response packets, and executes the timer events.</li>
<li>The main thread, I/O thread, and worker thread are driven by events separately.</li>
<li>Threads exchange data through the lock-free queue and send notifications through tunnels.</li>
</ul>
<p><img src="/image/database/redis_multi_threads.jpeg" alt=""></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">                                                Memcached Redis</span><br><span class="line">Sub-millisecond latency                             Yes Yes</span><br><span class="line">Developer ease of use                               Yes Yes</span><br><span class="line">Data partitioning                                   Yes Yes</span><br><span class="line">Support for a broad set of programming languages    Yes Yes</span><br><span class="line">Advanced data structures                            -   Yes</span><br><span class="line">Multithreaded architecture                          Yes -</span><br><span class="line">Snapshots                                           -   Yes</span><br><span class="line">Replication                                         -   Yes</span><br><span class="line">Transactions                                        -   Yes</span><br><span class="line">Pub/Sub                                             -   Yes</span><br><span class="line">Lua scripting                                       -   Yes</span><br><span class="line">Geospatial support                                  -   Yes</span><br></pre></td></tr></table></figure>

<h1 id="Redis-Datastructures"><a href="#Redis-Datastructures" class="headerlink" title="Redis Datastructures"></a>Redis Datastructures</h1><p>Redis的 5 种对象类型：</p>
<ul>
<li>string</li>
<li>hash</li>
<li>list</li>
<li>set</li>
<li>sorted set</li>
</ul>
<h2 id="Redis-Memory-model"><a href="#Redis-Memory-model" class="headerlink" title="Redis Memory model"></a>Redis Memory model</h2><p>丰富的类型是 Redis 相对于Memcached等的一大优势。在了解了 Redis 5 种对象类型用法和特点的基础上，进一步了解 <strong>Redis 的内存模型</strong>，对Redis的使用会有很大帮助!</p>
<ul>
<li>估算Redis内存使用量。目前为止，内存的使用成本仍然相对较高，使用内存不能无所顾忌；根据需求合理的评估Redis的内存使用量，选择合适的机器配置，可以在满足需求的情况下节约成本。</li>
<li>优化内存占用。了解Redis内存模型可以选择更合适的数据类型和编码，更好的利用Redis内存。</li>
<li>分析解决问题。当Redis出现阻塞、内存占用等问题时，尽快发现导致问题的原因，便于分析解决问题。</li>
</ul>
<p>Redis占用内存的情况及如何查询、不同的对象类型在内存中的编码方式、内存分配器（jemalloc）、简单动态字符串（SDS）、RedisObject等</p>
<h3 id="1-Redis内存统计"><a href="#1-Redis内存统计" class="headerlink" title="1. Redis内存统计"></a>1. Redis内存统计</h3><p>在客户端通过 redis-cli 连接服务器后, 使用 info 命令可以查看内存使用情况</p>
<h3 id="2-Redis内存划分"><a href="#2-Redis内存划分" class="headerlink" title="2. Redis内存划分"></a>2. Redis内存划分</h3><p>除了数据以外，Redis的其它部分也会占用内存。</p>
<p>1、数据<br>作为数据库，数据是最主要的部分，这部分占用的内存会统计在used_memory中。</p>
<p>Redis 提供的 5 种类型是对外提供的。实际上，在Redis内部，每种类型可能有2种或更多的内部编码实现。此外，Redis在存储对象时，并不是直接将数据扔进内存，而是会对对象进行各种包装：如RedisObject、SDS等。</p>
<p>2、进程本身运行需要的内存<br>Redis 主进程本身运行肯定需要占用内存，如代码、常量池等等。这部分内存大约几兆，在大多数生产环境中与Redis数据占用的内存相比可以忽略。这部分内存不是由jemalloc分配，因此不会统计在used_memory中。</p>
<p>补充说明：除了主进程外，Redis创建的子进程运行也会占用内存，如Redis执行AOF、RDB重写时创建的子进程。当然，这部分内存不属于Redis进程，也不会统计在used_memory和used_memory_rss中。</p>
<p>3、缓冲内存</p>
<p>缓冲内存包括：<br>客户端缓冲区：存储客户端连接的输入输出缓冲；<br>复制积压缓冲区：用于部分复制功能；<br>AOF缓冲区：用于在进行AOF重写时，保存最近的写入命令。</p>
<p>在了解相应功能之前，不需要知道这些缓冲的细节。这部分内存由jemalloc分配，因此会统计在used_memory中。</p>
<p>4、内存碎片<br>内存碎片是Redis在分配、回收物理内存过程中产生的。例如，如果对数据更改频繁，而且数据之间的大小相差很大，可能导致Redis释放的空间在物理内存中并没有释放，但Redis又无法有效利用，这就形成了内存碎片。内存碎片不会统计在used_memory中。</p>
<p>内存碎片的产生与对数据进行的操作、数据的特点等都有关。此外，与使用的内存分配器也有关系——如果内存分配器设计合理，可以尽可能的减少内存碎片的产生。后面将要说到的jemalloc便在控制内存碎片方面做的很好。</p>
<p>如果Redis服务器中的内存碎片已经很大，可以通过安全重启的方式减小内存碎片。因为重启之后，Redis重新从备份文件中读取数据，在内存中进行重排，为每个数据重新选择合适的内存单元，减小内存碎片。</p>
<h3 id="3-Redis-数据存储的细节"><a href="#3-Redis-数据存储的细节" class="headerlink" title="3. Redis 数据存储的细节"></a>3. Redis 数据存储的细节</h3><p>。。。</p>
<p>Redis 内部使用一个redisObject对象来表示所有的key和value。redisObject主要的信息包括数据类型（type）、编码方式(encoding)、数据指针（ptr）、虚拟内存（vm）等。type代表一个value对象具体是何种数据类型，encoding是不同数据类型在redis内部式。</p>
<p><img src="/image/database/redisObject.png" alt="redisObject 对象示意图"></p>
<h4 id="String-类型"><a href="#String-类型" class="headerlink" title="String 类型"></a>String 类型</h4><p>字符串是Redis值的最基础的类型。Redis中使用的字符串是通过包装的，基于c语言字符数组实现的简单动态字符串(simple dynamic string, SDS)一个抽象数据结构。</p>
<p>SDS 源码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sdshdr</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> len; <span class="comment">//len表示buf中存储的字符串的长度。</span></span><br><span class="line">    <span class="keyword">int</span> <span class="built_in">free</span>; <span class="comment">//free表示buf中空闲空间的长度。</span></span><br><span class="line">    <span class="keyword">char</span> buf[]; <span class="comment">//buf用于存储字符串内容。</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>SDS 与 C 字符串的比较</p>
<p>SDS 在 C 字符串的基础上加入了free和len字段，带来了很多好处：</p>
<p>获取字符串长度：SDS是O(1)，C字符串是O(n)。</p>
<p>缓冲区溢出：使用C字符串的API时，如果字符串长度增加（如strcat操作）而忘记重新分配内存，很容易造成缓冲区的溢出；而SDS由于记录了长度，相应的API在可能造成缓冲区溢出时会自动重新分配内存，杜绝了缓冲区溢出。</p>
<p>修改字符串时内存的重分配：对于C字符串，如果要修改字符串，必须要重新分配内存（先释放再申请），因为如果没有重新分配，字符串长度增大时会造成内存缓冲区溢出，字符串长度减小时会造成内存泄露。而对于SDS，由于可以记录len和free，因此解除了字符串长度和空间数组长度之间的关联，可以在此基础上进行优化——空间预分配策略（即分配内存时比实际需要的多）使得字符串长度增大时重新分配内存的概率大大减小；惰性空间释放策略使得字符串长度减小时重新分配内存的概率大大减小。</p>
<p>存取二进制数据：SDS 可以，C 字符串不可以。因为C字符串以空字符作为字符串结束的标识，而对于一些二进制文件（如图片等），内容可能包括空字符串，因此C字符串无法正确存取；而SDS以字符串长度len来作为字符串结束标识，因此没有这个问题。</p>
<p>此外，由于SDS中的buf仍然使用了C字符串（即以‘\0’结尾），因此SDS可以使用C字符串库中的部分函数。但是需要注意的是，只有当SDS用来存储文本数据时才可以这样使用，在存储二进制数据时则不行（‘\0’不一定是结尾）。</p>
<p>参考：<br><a href="https://blog.csdn.net/tTU1EvLDeLFq5btqiK/article/details/81140409" target="_blank" rel="noopener">https://blog.csdn.net/tTU1EvLDeLFq5btqiK/article/details/81140409</a><br><a href="https://blog.csdn.net/qq_26624661/article/details/79269740" target="_blank" rel="noopener">https://blog.csdn.net/qq_26624661/article/details/79269740</a></p>
<h3 id="Redis-实现分布式锁？"><a href="#Redis-实现分布式锁？" class="headerlink" title="Redis 实现分布式锁？"></a>Redis 实现分布式锁？</h3><p>锁的本质就是互斥，保证任何时候能有一个客户端持有同一个锁，如果考虑使用redis来实现一个分布式锁，最简单的方案就是在实例里面创建一个键值，释放锁的时候，将键值删除。但是一个可靠完善的分布式锁需要考虑的细节比较多，我们就来看看如何写一个正确的分布式锁。</p>
<p>单机版分布式锁 SETNX</p>
<p>setNX 命令作用是 SET if Not eXists，我们利用它来实现一个简单的锁。</p>
<p>锁的获取：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SET &lt;resource_name&gt; &lt;my_random_value&gt; NX PX 30000</span><br></pre></td></tr></table></figure>

<p>锁的释放：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> redis.call(<span class="string">"get"</span>, KEYS[<span class="number">1</span>]) == ARGV[<span class="number">1</span>] <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">return</span> redis.call(<span class="string">"del"</span>,KEYS[<span class="number">1</span>])</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>几个细节需要注意：</p>
<ul>
<li><p>首先在获取锁的时候我们需要设置设置超时时间。设置超时时间是为了，防止客户端崩溃，或者网络出现问题以后锁一直被持有。真个系统就死锁了。</p>
</li>
<li><p>使用 setNX 命令，保证查询和写入两个步骤是原子的</p>
</li>
<li><p>在锁释放的时候我们判断了KEYS[1]) == ARGV[1]，在这里 KEYS[1]是从redis里面取出来的value，ARGV[1]是上文生成的my_random_value。之所以进行以上的判断，是为了保证锁被锁的持有者释放。我们假设不进行这一步校验：</p>
<ul>
<li>客户端A获取锁，后发线程挂起了。时间大于锁的过期时间。</li>
<li>锁过期后，客户端B获取锁。</li>
<li>客户端A恢复以后，处理完相关事件，向redis发起 del命令。锁被释放</li>
<li>客户端C获取锁。这个时候一个系统中同时两个客户端持有锁。</li>
</ul>
</li>
</ul>
<p>造成这个问题的关键，在于客户端B持有的锁，被客户端A释放了。</p>
<ul>
<li>锁的释放必须使用 lua 脚本，保证操作的原子性。锁的释放包含了 get，判断，del 三个步骤。如果不能保证三个步骤的原子性，分布式锁就会有并发问题。</li>
</ul>
<p>注意了以上细节，一个单redis节点的分布式锁就达成了。</p>
<p>在这个分布式锁中还是存在一个单点的redis。也许你会说，Redis是 master-slave的架构，发生故障的时候切换到slave就好，但是Redis的复制是异步的。</p>
<p>如果在客户端A在master上拿到了锁。<br>在master将数据同步到slave上之前，master宕机。<br>客户端B就从slave上又一次拿到了锁。<br>这样由于Master的宕机，造成了同时多人持有锁。如果你的系统可用接受短时时间内，有多人持有锁。这个简单的方案就能解决问题。</p>
<p>但是如果解决这个问题。Redis的官方提供了一个Redlock的解决方案。</p>
<h3 id="RedLock-的实现"><a href="#RedLock-的实现" class="headerlink" title="RedLock 的实现"></a>RedLock 的实现</h3><p>为了解决，Redis 单点的问题。Redis的作者提出了RedLock的解决方案。方案非常的巧妙和简洁。<br>RedLock的核心思想就是，同时使用多个Redis Master来冗余，且这些节点都是完全的独立的，也不需要对这些节点之间的数据进行同步。</p>
<p>假设我们有 N 个 Redis 节点，N 应该是一个大于 2 的奇数。RedLock 的实现步骤:</p>
<ul>
<li>取得当前时间</li>
<li>使用上文提到的方法依次获取 N 个节点的 Redis 锁。</li>
<li>如果获取到的锁的数量大于 （N/2+1）个，且获取的时间小于锁的有效时间(lock validity time)就认为获取到了一个有效的锁。锁自动释放时间就是最初的锁释放时间减去之前获取锁所消耗的时间。</li>
<li>如果获取锁的数量小于 （N/2+1），或者在锁的有效时间(lock validity time)内没有获取到足够的说，就认为获取锁失败。这个时候需要向所有节点发送释放锁的消息。<br>对于释放锁的实现就很简单了。向所有的 Redis 节点发起释放的操作，无论之前是否获取锁成功。</li>
</ul>
<p>同时需要注意几个细节：</p>
<p>重试获取锁的间隔时间应当是一个随机范围而非一个固定时间。这样可以防止，多客户端同时一起向 Redis 集群发送获取锁的操作，避免同时竞争。同时获取相同数量锁的情况。（虽然概率很低）<br>如果某 master 节点故障之后，回复的时间间隔应当大于锁的有效时间。</p>
<p>假设有 A，B，C 三个 Redis 节点。<br>客户端 foo 获取到了 A、B 两个锁。<br>这个时候 B 宕机，所有内存的数据丢失。<br>B 节点恢复。<br>这个时候客户端bar重新获取锁，获取到B，C两个节点。<br>此时又有两个客户端获取到锁了。</p>
<p>所以如果恢复的时间将大于锁的有效时间，就可以避免以上情况发生。同时如果性能要求不高，甚至可以开启Redis的持久化选项。</p>
<p>总结<br>了解了Redis分布式的实现以后，其实觉得大多数的分布式系统其实原理很简单，但是为了保证分布式系统的可靠性需要注意很多的细节，琐碎异常。<br>RedLock算法实现的分布式锁就是简单高效，思路相当巧妙。</p>
<p>虽然看上去 RedLock 实现了分布式锁，但是网上有人（Martin Kleppmann）对这种实现发出了批评，他先是提出了两个使用锁的原因：</p>
<p>1）提升效率，用锁来保证一个任务没有必要被执行两次。比如（很昂贵的计算）<br>2）保证正确，使用锁来保证任务按照正常的步骤执行，防止两个节点同时操作一份数据，造成文件冲突，数据丢失。</p>
<p>然后，其指出，对于第一种原因，我们对锁是有一定宽容度的，就算发生了两个节点同时工作，对系统的影响也仅仅是多付出了一些计算的成本，没什么额外的影响。这个时候 使用单点的 Redis 就能很好的解决问题，没有必要使用RedLock，维护那么多的Redis实例，提升系统的维护成本。</p>
<p>对于第二种原因，对正确性严格要求的场景（比如订单，或者消费），就算使用了 RedLock 算法仍然不能保证锁的正确性。</p>
<p>因为，RedLock 只是保证了锁的高可用性，并没有保证锁的正确性。</p>
<p>Martin给出了一个解决的方案，增加一个 token-fencing，它是单调递增的，我们可以把其理解为一个乐观锁，所以 RedLock 是一个严重依赖系统时钟的分布式系统</p>
<p>最后， Redis 作者 antirez 还打出了一个暴击，既然 Martin 提出的系统使用 fecting token 保证数据的顺序处理。还需要 RedLock，或者别的分布式锁 干啥？？</p>
<h3 id="Redis-数据库实现与键过期"><a href="#Redis-数据库实现与键过期" class="headerlink" title="Redis 数据库实现与键过期"></a>Redis 数据库实现与键过期</h3><h4 id="1）Redis-的数据库实现"><a href="#1）Redis-的数据库实现" class="headerlink" title="1）Redis 的数据库实现"></a>1）Redis 的数据库实现</h4><p>主要在 <code>server.h/redisServer/</code> 中</p>
<ol>
<li>redisServer</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">redisServer</span>&#123;</span></span><br><span class="line">    redisDb *db; <span class="comment">// 保存 db 的数组</span></span><br><span class="line">    <span class="keyword">int</span> dbnum;   <span class="comment">// db 的数量</span></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>redisDb</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">redisDb</span> &#123;</span></span><br><span class="line">    dict *dict;                 <span class="comment">/* The keyspace for this DB */</span></span><br><span class="line">    dict *expires;              <span class="comment">/* Timeout of keys with a timeout set */</span></span><br><span class="line">    dict *blocking_keys;        <span class="comment">/* Keys with clients waiting for data (BLPOP)*/</span></span><br><span class="line">    dict *ready_keys;           <span class="comment">/* Blocked keys that received a PUSH */</span></span><br><span class="line">    dict *watched_keys;         <span class="comment">/* WATCHED keys for MULTI/EXEC CAS */</span></span><br><span class="line">    <span class="keyword">int</span> id;                     <span class="comment">/* Database ID */</span></span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">long</span> avg_ttl;          <span class="comment">/* Average TTL, just for stats */</span></span><br><span class="line">&#125; redisDb;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>dict</li>
</ol>
<p><img src="/image/database/dict_struacture.png" alt=""></p>
<p>总体来说 redis 的 server 包含若干个（默认16个） redisDb 数据库。</p>
<p><img src="/image/database/redisServer.jpg" alt=""></p>
<p>Redis 是一个 kv 存储的键值对数据库。其中字典 dict 保存了数据库中的所有键值对。</p>
<p>在执行对键的读写操作的时候，Redis 还要做一些额外的维护动作：</p>
<ul>
<li>维护 hit 和 miss 两个计数器。用于统计 Redis 的缓存命中率。</li>
<li>更新键的 LRU 时间，记录键的最后活跃时间。</li>
<li>如果在读取的时候发现键已经过期，Redis 先删除这个过期的键然后再执行余下操作。</li>
<li>如果有客户对这个键执行了 WATCH 操作，会把这个键标记为 dirty，让事务注意到这个键已经被改过。</li>
<li>没修改一次 dirty 会增加1。</li>
<li>如果服务器开启了数据库通知功能，键被修改之后，会按照配置发送通知。</li>
</ul>
<h4 id="2）Redis-键过期的策略"><a href="#2）Redis-键过期的策略" class="headerlink" title="2）Redis 键过期的策略"></a>2）Redis 键过期的策略</h4><p>我们可以看到 redisDb 结构体中 expires 就是用来保存过期时间的。</p>
<p>对于过期的判断逻辑很简单：</p>
<ul>
<li>在 expires 字典中检查 key 是否存在。</li>
<li>如果 key 存在，判断 value 的时间戳是否小于当前系统时间戳。</li>
</ul>
<p>key的删除有三种策略：</p>
<ul>
<li>定时删除，Redis定时的删除内存里面所有过期的键值对，这样能够保证内存友好，过期的key都会被删除，但是如果key的数量很多，一次删除需要CPU运算，CPU不友好。</li>
<li>惰性删除，只有 key 在被调用的时候才去检查键值对是否过期，但是会造成内存中存储大量的过期键值对，内存不友好，但是极大的减轻CPU 的负担。</li>
<li>定时部分删除，Redis定时扫描过期键，但是只删除部分，至于删除多少键，根据当前 Redis 的状态决定。</li>
</ul>
<p>这三种策略就是对时间和空间有不同的倾向。Redis 为了平衡时间和空间，采用了后两种策略，<strong>惰性删除</strong>和<strong>定时部分删除</strong>。</p>
<p>惰性删除比较简单，不做过多介绍。主要讨论一下定时部分删除。</p>
<p>过期键的定时删除的策略由 expire.c/activeExpireCycle() 函数实现，server.c/serverCron() 定时的调用 activieExpireCycle() 。</p>
  
	</div>
		<footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/SystemProgramming/">SystemProgramming</a>
</div>


</div>



	<div class="article-share" id="share">
	
	  <div data-url="https://juniway.net/SystemProgramming/core-techs-database-redis/" data-title="Redis Notes | BN Stack" data-tsina="1324264260" class="share clearfix">
	  </div>
	
	</div>


</footer>

   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev">
 <a href="/SystemProgramming/core-techs-database-memcached/" title="Memcached Notes">
  <strong>Prev：</strong><br>
  <span>
  Memcached Notes</span>
</a>
</div>


<div class="next">
<a href="/SystemProgramming/core-techs-database-bigtable/" title="BigTable Notes">
 <strong>Next：</strong><br>
 <span>BigTable Notes
</span>
</a>
</div>

</nav>


	


<section id="comments" class="comment">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>

</div>  
      <div class="openaside"><a class="navbutton" href="#" title="Show Sidebar"></a></div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="Hide Sidebar"></a></div>
<aside class="clearfix">

  <div class="widget popular">
  <h3 class="title">Popular</h3>
  <ul class="entry" id="js-popular">
  </ul>
</div>

  
<div class="categorieslist">
	<p class="asidetitle">Categories</p>
		<ul>
		
		  
		
		  
		
		  
			<li><a href="/categories/BigData/" title="BigData">BigData<sup>6</sup></a></li>
		  
		
		  
			<li><a href="/categories/Blockchain/" title="Blockchain">Blockchain<sup>16</sup></a></li>
		  
		
		  
			<li><a href="/categories/C/" title="C++">C++<sup>8</sup></a></li>
		  
		
		  
		
		  
			<li><a href="/categories/Database/" title="Database">Database<sup>4</sup></a></li>
		  
		
		  
			<li><a href="/categories/Distributed-System/" title="Distributed System">Distributed System<sup>30</sup></a></li>
		  
		
		  
			<li><a href="/categories/English/" title="English">English<sup>4</sup></a></li>
		  
		
		  
		
		  
			<li><a href="/categories/Git/" title="Git">Git<sup>10</sup></a></li>
		  
		
		  
			<li><a href="/categories/Go/" title="Go">Go<sup>1</sup></a></li>
		  
		
		  
		
		  
			<li><a href="/categories/Life/" title="Life">Life<sup>5</sup></a></li>
		  
		
		  
			<li><a href="/categories/Linux/" title="Linux">Linux<sup>25</sup></a></li>
		  
		
		  
			<li><a href="/categories/Macbook/" title="Macbook">Macbook<sup>4</sup></a></li>
		  
		
		  
		
		  
			<li><a href="/categories/Music/" title="Music">Music<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Network-Technology/" title="Network Technology">Network Technology<sup>4</sup></a></li>
		  
		
		  
		
		  
			<li><a href="/categories/Operating-System/" title="Operating System">Operating System<sup>5</sup></a></li>
		  
		
		  
		
		  
			<li><a href="/categories/Programming/" title="Programming">Programming<sup>58</sup></a></li>
		  
		
		  
			<li><a href="/categories/Sublime-Text/" title="Sublime Text">Sublime Text<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/System-Programming/" title="System Programming">System Programming<sup>6</sup></a></li>
		  
		
		  
			<li><a href="/categories/SystemProgramming/" title="SystemProgramming">SystemProgramming<sup>19</sup></a></li>
		  
		
		  
			<li><a href="/categories/Tools-and-Build/" title="Tools and Build">Tools and Build<sup>20</sup></a></li>
		  
		
		  
			<li><a href="/categories/Vim/" title="Vim">Vim<sup>4</sup></a></li>
		  
		
		  
			<li><a href="/categories/VirtualBox/" title="VirtualBox">VirtualBox<sup>13</sup></a></li>
		  
		
		  
			<li><a href="/categories/Web/" title="Web">Web<sup>3</sup></a></li>
		  
		
		  
			<li><a href="/categories/life/" title="life">life<sup>1</sup></a></li>
		  
		
		  
		
		  
			<li><a href="/categories/南昌/" title="南昌">南昌<sup>3</sup></a></li>
		  
		
		</ul>
</div>


  
  <div class="archiveslist">
    <p class="asidetitle"><a href="/archives">Archives</a></p>
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">五月 2020</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">三月 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">五月 2019</a><span class="archive-list-count">19</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">四月 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">二月 2019</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">一月 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">十二月 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">十一月 2018</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">十月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">九月 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">八月 2018</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">七月 2018</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">五月 2018</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">三月 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">二月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">一月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">十二月 2017</a><span class="archive-list-count">19</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">十一月 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">十月 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">九月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">八月 2017</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">六月 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">三月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">二月 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">一月 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">十一月 2016</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">十月 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">九月 2016</a><span class="archive-list-count">18</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">八月 2016</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">七月 2016</a><span class="archive-list-count">36</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">六月 2016</a><span class="archive-list-count">17</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">五月 2016</a><span class="archive-list-count">19</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">四月 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">一月 2016</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">十一月 2015</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">十月 2015</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">九月 2015</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/08/">八月 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/07/">七月 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/06/">六月 2015</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/12/">十二月 2014</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/09/">九月 2014</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/08/">八月 2014</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/09/">九月 2013</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/08/">八月 2013</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/07/">七月 2013</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/06/">六月 2013</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/03/">三月 2013</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/02/">二月 2013</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/01/">一月 2013</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/10/">十月 2012</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/09/">九月 2012</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/06/">六月 2012</a><span class="archive-list-count">1</span></li></ul>
  </div>


  
<div class="tagslist">
	<p class="asidetitle">Tags</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/Hadoop/" title="Hadoop">Hadoop<sup>6</sup></a></li>
			
		
			
				<li><a href="/tags/Blockchain/" title="Blockchain">Blockchain<sup>5</sup></a></li>
			
		
			
				<li><a href="/tags/Golang/" title="Golang">Golang<sup>5</sup></a></li>
			
		
			
				<li><a href="/tags/CPP/" title="CPP">CPP<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/C/" title="C++">C++<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/Proxying/" title="Proxying">Proxying<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/IPFS/" title="IPFS">IPFS<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/文化/" title="文化">文化<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/Ethereum/" title="Ethereum">Ethereum<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/Protobuf/" title="Protobuf">Protobuf<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/方言/" title="方言">方言<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/HTML/" title="HTML">HTML<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/德州扑克/" title="德州扑克">德州扑克<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Ukelele/" title="Ukelele">Ukelele<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Ukulele/" title="Ukulele">Ukulele<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/历史/" title="历史">历史<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Python/" title="Python">Python<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/tags/" title="tags">tags<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Virtual-Host/" title="Virtual Host">Virtual Host<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/C-14/" title="C++14">C++14<sup>1</sup></a></li>
			
		
		</ul>
</div>


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS</a>
</div>

</aside>
</div>
    </div>
    <footer><div id="footer">
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> Welcome to Alex&#39;s blog! <br>
			Let&#39;s do something technically.</p>
	</section>
	 
	<div class="social-font">
		
		<a href="http://weibo.com/1324264260" target="_blank" class="icon-weibo" title="微博"></a>
		
		
		<a href="https://github.com/juniway" target="_blank" class="icon-github" title="github"></a>
		
		
		
		
		
		
		
		<a href="http://www.zhihu.com/people/juniway" target="_blank" class="icon-zhihu" title="知乎"></a>
		
		
		
	</div>
			
		

	<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a>
		
		<script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
		<span id="busuanzi_container_site_uv" style="display:none">
			<br>total: <span id="busuanzi_value_site_uv"></span>, current: <span id="busuanzi_value_page_pv"></span>
		</span>
		
	</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize();
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
    }
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  c.click(function(){
    ta.css('display', 'block').addClass('fadeIn');
  });
  o.click(function(){
    ta.css('display', 'none');
  });
  $(window).scroll(function(){
    ta.css("top",Math.max(140,320-$(this).scrollTop()));
  });
});
</script>


<script type="text/javascript">
$(document).ready(function(){
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina'),
      description = $this.attr('description');
  var html = [
  '<div class="hoverqrcode clearfix"></div>',
  '<a class="overlay" id="qrcode"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="微信"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="微博"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);

  $('.hoverqrcode').hide();

  var myWidth = 0;
  function updatehoverqrcode(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
    var qrsize = myWidth > 1024 ? 200:100;
    var options = {render: 'image', size: qrsize, fill: '#2ca6cb', text: url, radius: 0.5, quiet: 1};
    var p = $('.article-share-qrcode').position();
    $('.hoverqrcode').empty().css('width', qrsize).css('height', qrsize)
                          .css('left', p.left-qrsize/2+20).css('top', p.top-qrsize-10)
                          .qrcode(options);
  };
  $(window).resize(function(){
    $('.hoverqrcode').hide();
  });
  $('.article-share-qrcode').click(function(){
    updatehoverqrcode();
    $('.hoverqrcode').toggle();
  });
  $('.article-share-qrcode').hover(function(){}, function(){
      $('.hoverqrcode').hide();
  });
});
</script>




<script type="text/javascript">

var disqus_shortname = 'juniway';

(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
</script>






<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
});
</script>



<!-- Analytics Begin -->

<script async src="https://www.googletagmanager.com/gtag/js?id=UA-140202478-1"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'UA-140202478-1');
</script>








<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="Back to Top"><img src="/img/scrollup.png"></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->


  </body>
</html>
